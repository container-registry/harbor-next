# Testing and Quality Assurance Tasks
# Linting, vulnerability scanning, and tests

version: '3'

includes:
  build:
    taskfile: ./build.yml
    internal: true

tasks:
  # ============================================================================
  # Linting Tasks
  # ============================================================================

  lint:
    desc: "Lint Go code with golangci-lint in Docker"
    cmds:
      - task build:gen-apis
      - |
        echo "ðŸ” Running golangci-lint..."
        docker run --rm \
          -v $(pwd):/harbor \
          -w /harbor/src \
          golangci/golangci-lint:{{.GOLANGCILINT_VERSION}}-alpine \
          golangci-lint -v run --timeout=10m

  lint:report:
    desc: "Lint Go code and write report to golangci-lint.report"
    cmds:
      - task build:gen-apis
      - |
        echo "ðŸ“Š Generating lint report..."
        docker run --rm \
          -v $(pwd):/harbor \
          -w /harbor/src \
          golangci/golangci-lint:{{.GOLANGCILINT_VERSION}}-alpine \
          golangci-lint -v run --timeout=10m \
          --out-format github-actions \
          --issues-exit-code 0 > golangci-lint.report
        echo "âœ… Report saved to: golangci-lint.report"

  lint:api:
    desc: "Lint swagger.yaml with Spectral in Docker"
    sources:
      - "api/v2.0/swagger.yaml"
    cmds:
      - |
        echo "ðŸ” Linting OpenAPI spec..."
        docker run --rm \
          -v $(pwd):/src \
          -w /src \
          stoplight/spectral:{{.SPECTRAL_VERSION}} \
          lint ./api/v2.0/swagger.yaml

  # ============================================================================
  # Vulnerability Scanning
  # ============================================================================

  vuln-check:
    desc: "Scan Go dependencies for known vulnerabilities"
    cmds:
      - |
        if ! command -v govulncheck &> /dev/null; then
          echo "Installing govulncheck..."
          go install golang.org/x/vuln/cmd/govulncheck@latest
        fi
      - |
        echo "ðŸ”’ Running govulncheck..."
        cd src && govulncheck -show verbose ./...

  vuln-report:
    desc: "Scan Go dependencies and write SARIF report to govulncheck.sarif"
    cmds:
      - |
        if ! command -v govulncheck &> /dev/null; then
          echo "Installing govulncheck..."
          go install golang.org/x/vuln/cmd/govulncheck@latest
        fi
      - |
        echo "ðŸ“Š Generating vulnerability report..."
        cd src && govulncheck -format sarif ./... > ../govulncheck.sarif
        echo "âœ… SARIF report saved to: govulncheck.sarif"

  # ============================================================================
  # Unit Tests
  # ============================================================================

  unit:
    desc: "Run Go unit tests with race detection"
    cmds:
      - |
        echo "ðŸ§ª Running unit tests..."
        cd src && go test -v -race -cover ./...

  unit:coverage:
    desc: "Run Go unit tests and generate HTML coverage report"
    cmds:
      - |
        echo "ðŸ§ª Running unit tests with coverage..."
        cd src && go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        go tool cover -html=coverage.out -o coverage.html
        echo "âœ… Coverage report: src/coverage.html"

  unit:watch:
    desc: "Re-run Go unit tests on file changes (requires watchexec)"
    cmds:
      - |
        if ! command -v watchexec &> /dev/null; then
          echo "âŒ watchexec not found. Install with: brew install watchexec"
          exit 1
        fi
      - |
        echo "ðŸ§ª Running tests in watch mode..."
        cd src && watchexec -e go -r -- go test -v ./...

  # ============================================================================
  # Integration Tests
  # ============================================================================

  integration:
    desc: "Run API integration tests (requires running dev environment)"
    cmds:
      - |
        echo "ðŸ§ª Running integration tests..."
        ./tests/ci/api_run.sh

  # ============================================================================
  # Mock Validation
  # ============================================================================

  check-mocks:
    desc: "Verify generated mock files match committed versions"
    cmds:
      - |
        echo "Checking mocks..."
        res=$(git status -s src/ | awk '{ printf("%s\n", $2) }' | grep -E '.*.go' || true)
        if [ -n "$res" ]; then
          echo "âŒ Mock files are out of date:"
          echo "$res"
          exit 1
        fi
        echo "âœ… All mock files are up to date"

  generate-mocks:
    desc: "Regenerate all mock files with mockery"
    cmds:
      - |
        if ! command -v mockery &> /dev/null; then
          echo "Installing mockery..."
          go install github.com/vektra/mockery/v2@latest
        fi
      - |
        echo "ðŸ”§ Generating mocks..."
        cd src && mockery --all --dir . --output ./testing/mocks
      - echo "âœ… Mocks generated"

  # ============================================================================
  # Frontend Tests
  # ============================================================================

  frontend:test:
    desc: "Run frontend tests once"
    dir: src/portal
    cmds:
      - npm run test -- --watch=false

  frontend:test:watch:
    desc: "Run frontend tests in watch mode"
    dir: src/portal
    cmds:
      - npm run test -- --watch

  frontend:lint:
    desc: "Lint frontend TypeScript code"
    dir: src/portal
    cmds:
      - npm run lint

  # ============================================================================
  # Aggregate Test Tasks
  # ============================================================================

  all:
    desc: "Run all linters, vulnerability scan, and unit tests"
    cmds:
      - task: lint:api
      - task: lint
      - task: vuln-check
      - task: unit
      - echo "âœ… All tests passed!"

  ci:
    desc: "Run full CI pipeline with reports (lint, vuln scan, unit tests)"
    cmds:
      - task: lint:api
      - task: lint:report
      - task: vuln-report
      - task: unit:coverage
      - echo "âœ… CI checks complete"

  quick:
    desc: "Run API lint and unit tests only (fast validation)"
    cmds:
      - task: lint:api
      - task: unit
      - echo "âœ… Quick validation passed"

  # ============================================================================
  # Utilities
  # ============================================================================

  clean:
    desc: "Remove lint reports, SARIF files, and coverage output"
    cmds:
      - rm -f golangci-lint.report
      - rm -f govulncheck.sarif
      - rm -f src/coverage.out src/coverage.html
      - echo "âœ… Test artifacts cleaned"
