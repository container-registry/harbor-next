# Testing and Quality Assurance Tasks
# Linting, vulnerability scanning, and tests

version: '3'

includes:
  build:
    taskfile: ./build.yml
    dir: ..
    internal: true

tasks:
  # ============================================================================
  # Linting Tasks
  # ============================================================================

  _golangci-lint:
    internal: true
    deps: [build:gen-apis]
    cmd: >-
      docker run --rm
      -v $(pwd):/harbor -w /harbor/src
      golangci/golangci-lint:{{.GOLANGCILINT_VERSION}}-alpine
      golangci-lint -v run --timeout=10m {{.LINT_ARGS}}

  lint:
    desc: "Lint Go code with golangci-lint in Docker"
    cmds:
      - task: _golangci-lint

  lint:report:
    desc: "Lint Go code and write report to golangci-lint.report"
    cmds:
      - task: _golangci-lint
        vars: { LINT_ARGS: "--output.json.path golangci-lint.report --issues-exit-code 0" }

  lint:api:
    desc: "Lint swagger.yaml with Spectral in Docker"
    sources:
      - "api/v2.0/swagger.yaml"
    cmd: >-
      docker run --rm
      -v $(pwd):/src -w /src
      stoplight/spectral:{{.SPECTRAL_VERSION}}
      lint ./api/v2.0/swagger.yaml

  # ============================================================================
  # Vulnerability Scanning
  # ============================================================================

  _require-govulncheck:
    internal: true
    run: once
    status:
      - command -v govulncheck
    cmd: go install golang.org/x/vuln/cmd/govulncheck@latest

  vuln-check:
    desc: "Scan Go dependencies for known vulnerabilities"
    deps: [_require-govulncheck]
    dir: src
    cmd: govulncheck -show verbose ./...

  vuln-report:
    desc: "Scan Go dependencies and write SARIF report to govulncheck.sarif"
    deps: [_require-govulncheck]
    dir: src
    cmd: govulncheck -format sarif ./... > ../govulncheck.sarif

  # ============================================================================
  # Unit Tests
  # ============================================================================

  unit:
    desc: "Run Go unit tests with race detection"
    dir: src
    cmd: go test -v -race -cover ./...

  unit:coverage:
    desc: "Run Go unit tests and generate HTML coverage report"
    dir: src
    cmds:
      - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
      - go tool cover -html=coverage.out -o coverage.html

  unit:watch:
    desc: "Re-run Go unit tests on file changes (requires watchexec)"
    preconditions:
      - sh: command -v watchexec
        msg: "watchexec not found. Install: brew install watchexec"
    dir: src
    cmd: watchexec -e go -r -- go test -v ./...

  # ============================================================================
  # Integration Tests
  # ============================================================================

  integration:
    desc: "Run API integration tests (requires running dev environment)"
    cmd: ./tests/ci/api_run.sh

  # ============================================================================
  # Mock Validation
  # ============================================================================

  check-mocks:
    desc: "Verify generated mock files match committed versions"
    cmds:
      - |
        res=$(git status -s src/ | awk '{ printf("%s\n", $2) }' | grep -E '.*.go' || true)
        if [ -n "$res" ]; then
          echo "Mock files are out of date:"
          echo "$res"
          exit 1
        fi

  _require-mockery:
    internal: true
    run: once
    status:
      - command -v mockery
    cmd: go install github.com/vektra/mockery/v2@latest

  generate-mocks:
    desc: "Regenerate all mock files with mockery"
    deps: [_require-mockery]
    dir: src
    cmd: mockery --all --dir . --output ./testing/mocks

  # ============================================================================
  # Frontend Tests
  # ============================================================================

  frontend:test:
    desc: "Run frontend tests once"
    dir: src/portal
    cmd: npm run test -- --watch=false

  frontend:test:watch:
    desc: "Run frontend tests in watch mode"
    dir: src/portal
    cmd: npm run test -- --watch

  frontend:lint:
    desc: "Lint frontend TypeScript code"
    dir: src/portal
    cmd: npm run lint

  # ============================================================================
  # Aggregate Test Tasks
  # ============================================================================

  all:
    desc: "Run all linters, vulnerability scan, and unit tests"
    cmds:
      - task: lint:api
      - task: lint
      - task: vuln-check
      - task: unit

  ci:
    desc: "Run full CI pipeline with reports (lint, vuln scan, unit tests)"
    cmds:
      - task: lint:api
      - task: lint:report
      - task: vuln-report
      - task: unit:coverage

  quick:
    desc: "Run API lint and unit tests only (fast validation)"
    cmds:
      - task: lint:api
      - task: unit

  # ============================================================================
  # Utilities
  # ============================================================================

  clean:
    desc: "Remove lint reports, SARIF files, and coverage output"
    cmds:
      - rm -f golangci-lint.report
      - rm -f govulncheck.sarif
      - rm -f src/coverage.out src/coverage.html
