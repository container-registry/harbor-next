# Docker Image Building Tasks
# Uses Dockerfiles in dockerfile/ directory
# Must be run via root Taskfile (task image:*) - vars inherited from versions.env

version: '3'

includes:
  build: ./build.yml

tasks:
  # ============================================================================
  # Aggregate Image Build Tasks
  # ============================================================================

  all-images:
    desc: "üê≥ Build all Harbor Docker images for all platforms"
    deps:
      - image:core:linux-amd64
      - image:core:linux-arm64
      - image:jobservice:linux-amd64
      - image:jobservice:linux-arm64
      - image:registryctl:linux-amd64
      - image:registryctl:linux-arm64
      - image:exporter:linux-amd64
      - image:exporter:linux-arm64
      - image:portal:linux-amd64
      - image:portal:linux-arm64
      - image:registry:linux-amd64
      - image:registry:linux-arm64
      - image:trivy-adapter:linux-amd64
      - image:trivy-adapter:linux-arm64
      - image:nginx:linux-amd64
      - image:nginx:linux-arm64
    cmds:
      - |
        echo "‚úÖ All images built successfully"
        echo ""
        docker images | grep goharbor

  all-images:amd64:
    desc: "üê≥ Build all images for linux/amd64"
    deps:
      - image:core:linux-amd64
      - image:jobservice:linux-amd64
      - image:registryctl:linux-amd64
      - image:exporter:linux-amd64
      - image:portal:linux-amd64
      - image:registry:linux-amd64
      - image:trivy-adapter:linux-amd64
      - image:nginx:linux-amd64
    cmds:
      - echo "‚úÖ All AMD64 images built"

  all-images:arm64:
    desc: "üê≥ Build all images for linux/arm64"
    deps:
      - image:core:linux-arm64
      - image:jobservice:linux-arm64
      - image:registryctl:linux-arm64
      - image:exporter:linux-arm64
      - image:portal:linux-arm64
      - image:registry:linux-arm64
      - image:trivy-adapter:linux-arm64
      - image:nginx:linux-arm64
    cmds:
      - echo "‚úÖ All ARM64 images built"

  # ============================================================================
  # Core Image (requires binary)
  # ============================================================================

  image:core:*:
    desc: "Build Harbor Core Docker image"
    vars:
      PLATFORM: '{{index .MATCH 0}}'
      ARCH: '{{if eq .PLATFORM "linux-amd64"}}amd64{{else}}arm64{{end}}'
      TAG: "goharbor/harbor-core:{{.VERSION}}-{{.PLATFORM}}"
    deps:
      - build:binary:core:{{.PLATFORM}}
    cmds:
      - |
        echo "üê≥ Building Core image for {{.PLATFORM}}..."
        docker buildx build \
          --platform linux/{{.ARCH}} \
          --build-arg TARGETARCH={{.ARCH}} \
          -t {{.TAG}} \
          -f dockerfile/core.dockerfile \
          --load \
          .
      - |
        echo "‚úÖ Core image built: {{.TAG}}"
        docker images | grep harbor-core | head -1

  # ============================================================================
  # Jobservice Image (requires binary)
  # ============================================================================

  image:jobservice:*:
    desc: "Build Harbor Jobservice Docker image"
    vars:
      PLATFORM: '{{index .MATCH 0}}'
      ARCH: '{{if eq .PLATFORM "linux-amd64"}}amd64{{else}}arm64{{end}}'
      TAG: "goharbor/harbor-jobservice:{{.VERSION}}-{{.PLATFORM}}"
    deps:
      - build:binary:jobservice:{{.PLATFORM}}
    cmds:
      - |
        echo "üê≥ Building Jobservice image for {{.PLATFORM}}..."
        docker buildx build \
          --platform linux/{{.ARCH}} \
          --build-arg TARGETARCH={{.ARCH}} \
          -t {{.TAG}} \
          -f dockerfile/jobservice.dockerfile \
          --load \
          .
      - |
        echo "‚úÖ Jobservice image built: {{.TAG}}"
        docker images | grep harbor-jobservice | head -1

  # ============================================================================
  # Registryctl Image (requires binary)
  # ============================================================================

  image:registryctl:*:
    desc: "Build Harbor Registryctl Docker image"
    vars:
      PLATFORM: '{{index .MATCH 0}}'
      ARCH: '{{if eq .PLATFORM "linux-amd64"}}amd64{{else}}arm64{{end}}'
      TAG: "goharbor/harbor-registryctl:{{.VERSION}}-{{.PLATFORM}}"
    deps:
      - build:binary:registryctl:{{.PLATFORM}}
    cmds:
      - |
        echo "üê≥ Building Registryctl image for {{.PLATFORM}}..."
        docker buildx build \
          --platform linux/{{.ARCH}} \
          --build-arg TARGETARCH={{.ARCH}} \
          -t {{.TAG}} \
          -f dockerfile/registryctl.dockerfile \
          --load \
          .
      - |
        echo "‚úÖ Registryctl image built: {{.TAG}}"
        docker images | grep harbor-registryctl | head -1

  # ============================================================================
  # Exporter Image (requires binary)
  # ============================================================================

  image:exporter:*:
    desc: "Build Harbor Exporter Docker image"
    vars:
      PLATFORM: '{{index .MATCH 0}}'
      ARCH: '{{if eq .PLATFORM "linux-amd64"}}amd64{{else}}arm64{{end}}'
      TAG: "goharbor/harbor-exporter:{{.VERSION}}-{{.PLATFORM}}"
    deps:
      - build:binary:exporter:{{.PLATFORM}}
    cmds:
      - |
        echo "üê≥ Building Exporter image for {{.PLATFORM}}..."
        docker buildx build \
          --platform linux/{{.ARCH}} \
          --build-arg TARGETARCH={{.ARCH}} \
          -t {{.TAG}} \
          -f dockerfile/exporter.dockerfile \
          --load \
          .
      - |
        echo "‚úÖ Exporter image built: {{.TAG}}"
        docker images | grep harbor-exporter | head -1

  # ============================================================================
  # Portal Image (multi-stage, no binary needed)
  # ============================================================================

  image:portal:*:
    desc: "Build Harbor Portal Docker image (Angular frontend)"
    vars:
      PLATFORM: '{{index .MATCH 0}}'
      TAG: "goharbor/harbor-portal:{{.VERSION}}-{{.PLATFORM}}"
    cmds:
      - |
        echo "üê≥ Building Portal image for {{.PLATFORM}}..."
        echo "‚ö†Ô∏è  This is a multi-stage build and will take several minutes..."
        docker buildx build \
          --platform linux/{{.ARCH}} \
          -t {{.TAG}} \
          -f dockerfile/portal.dockerfile \
          --load \
          .
      - |
        echo "‚úÖ Portal image built: {{.TAG}}"
        docker images | grep harbor-portal | head -1

  # ============================================================================
  # Registry Image (multi-stage, builds from source)
  # ============================================================================

  image:registry:*:
    desc: "Build Docker Registry (Distribution) image"
    vars:
      PLATFORM: '{{index .MATCH 0}}'
      ARCH: '{{if eq .PLATFORM "linux-amd64"}}amd64{{else}}arm64{{end}}'
      TAG: "goharbor/registry-photon:{{.VERSION}}-{{.PLATFORM}}"
    cmds:
      - |
        echo "üê≥ Building Registry image for {{.PLATFORM}}..."
        docker buildx build \
          --platform linux/{{.ARCH}} \
          --build-arg GO_VERSION={{.GO_VERSION}} \
          --build-arg DISTRIBUTION_VERSION={{.DISTRIBUTION_VERSION}} \
          -t {{.TAG}} \
          -f dockerfile/registry.dockerfile \
          --load \
          .
      - |
        echo "‚úÖ Registry image built: {{.TAG}}"
        docker images | grep registry-photon | head -1

  # ============================================================================
  # Trivy Adapter Image (multi-stage)
  # ============================================================================

  image:trivy-adapter:*:
    desc: "Build Trivy Adapter Docker image"
    vars:
      PLATFORM: '{{index .MATCH 0}}'
      TAG: "goharbor/trivy-adapter-photon:{{.VERSION}}-{{.PLATFORM}}"
    cmds:
      - |
        echo "üê≥ Building Trivy Adapter image for {{.PLATFORM}}..."
        echo "‚ö†Ô∏è  This builds trivy-adapter from source..."
        docker buildx build \
          --platform linux/{{.ARCH}} \
          -t {{.TAG}} \
          -f dockerfile/trivy-adapter.dockerfile \
          --load \
          .
      - |
        echo "‚úÖ Trivy Adapter image built: {{.TAG}}"
        docker images | grep trivy-adapter | head -1

  # ============================================================================
  # Nginx Image (simple)
  # ============================================================================

  image:nginx:*:
    desc: "Build Harbor Nginx proxy image"
    vars:
      PLATFORM: '{{index .MATCH 0}}'
      TAG: "goharbor/nginx-photon:{{.VERSION}}-{{.PLATFORM}}"
    cmds:
      - |
        echo "üê≥ Building Nginx image for {{.PLATFORM}}..."
        docker buildx build \
          --platform linux/{{.ARCH}} \
          -t {{.TAG}} \
          -f dockerfile/nginx.dockerfile \
          --load \
          .
      - |
        echo "‚úÖ Nginx image built: {{.TAG}}"
        docker images | grep nginx-photon | head -1

  # ============================================================================
  # Utilities
  # ============================================================================

  clean:
    desc: "üßπ Clean all Harbor Docker images"
    cmds:
      - |
        echo "Removing Harbor images..."
        docker images | grep goharbor | awk '{print $3}' | xargs -r docker rmi -f || true
        echo "‚úÖ Images cleaned"

  prune:
    desc: "üßπ Prune Docker build cache"
    cmds:
      - docker builder prune -f
      - echo "‚úÖ Build cache pruned"

  list:
    desc: "üìã List all Harbor images"
    cmds:
      - |
        echo "Harbor Images:"
        docker images | grep -E "goharbor|REPOSITORY" || echo "No Harbor images found"

  inspect:*:
    desc: "üîç Inspect a specific Harbor image"
    vars:
      IMAGE: '{{index .MATCH 0}}'
    cmds:
      - |
        echo "Inspecting {{.IMAGE}}..."
        docker inspect goharbor/harbor-{{.IMAGE}}:{{.VERSION}}-linux-amd64

  test:*:
    desc: "üß™ Test if an image runs"
    vars:
      IMAGE: '{{index .MATCH 0}}'
    cmds:
      - |
        echo "Testing {{.IMAGE}} image..."
        docker run --rm --entrypoint /bin/sh \
          goharbor/harbor-{{.IMAGE}}:{{.VERSION}}-linux-amd64 \
          -c "echo 'Image OK'" || echo "‚ö†Ô∏è  Image test failed (may need specific entrypoint)"
