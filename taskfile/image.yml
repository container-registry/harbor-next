# Docker Image Building Tasks
# Uses Dockerfiles in dockerfile/ directory
# Must be run via root Taskfile (task image:*) - vars inherited from versions.env
#
# Configuration (in root Taskfile.yml):
#   IMAGE_REGISTRY:   8gears.container-registry.com
#   IMAGE_NAMESPACE:  8gcr/goharbor
#   IMAGE_PLATFORMS:  linux/amd64,linux/arm64
#
# Full image path: IMAGE_REGISTRY/IMAGE_NAMESPACE/<image>:<version>
# Example: 8gears.container-registry.com/8gcr/goharbor/harbor-core:v2.15.0
#
# Usage:
#   task image:core                              # multi-arch, push to registry
#   task image:core PUSH=false                   # build for native arch, load locally
#   task image:core IMAGE_PLATFORMS=linux/arm64  # single arch, push
#   task image:core PUSH=false IMAGE_PLATFORMS=linux/amd64  # specific arch, load locally
#   task images                                  # all images, push to registry
#   task images PUSH=false                       # all images, native arch, local

version: '3'

includes:
  build: ./build.yml

vars:
  # Detect native architecture
  NATIVE_ARCH:
    sh: |
      case "$(uname -m)" in
        x86_64|amd64) echo "linux/amd64" ;;
        arm64|aarch64) echo "linux/arm64" ;;
        *) echo "linux/amd64" ;;
      esac

tasks:
  # ============================================================================
  # Aggregate Build Tasks
  # ============================================================================

  all-images:
    desc: "üê≥ Build all Harbor Docker images"
    deps:
      - buildx:setup
    cmds:
      - for: [core, jobservice, registryctl, exporter, portal, registry, trivy-adapter, nginx]
        task: '{{.ITEM}}'
      - echo "‚úÖ All images built"

  # ============================================================================
  # Buildx Builder Setup
  # ============================================================================

  buildx:setup:
    desc: "üîß Create buildx builder for multi-platform builds"
    cmds:
      - |
        if docker buildx inspect {{.IMAGE_BUILDER}} >/dev/null 2>&1; then
          echo "Builder '{{.IMAGE_BUILDER}}' already exists"
        else
          echo "Creating builder '{{.IMAGE_BUILDER}}'..."
          docker buildx create \
            --name {{.IMAGE_BUILDER}} \
            --driver docker-container \
            --bootstrap
        fi
      - docker buildx use {{.IMAGE_BUILDER}}

  buildx:remove:
    desc: "üßπ Remove the multi-arch buildx builder"
    cmds:
      - |
        if docker buildx inspect {{.IMAGE_BUILDER}} >/dev/null 2>&1; then
          docker buildx rm {{.IMAGE_BUILDER}}
          echo "‚úÖ Builder '{{.IMAGE_BUILDER}}' removed"
        else
          echo "Builder '{{.IMAGE_BUILDER}}' does not exist"
        fi

  buildx:list:
    desc: "üìã List available buildx builders"
    cmds:
      - docker buildx ls

  # ============================================================================
  # Internal build task - called by public tasks with specific vars
  # ============================================================================

  _build:
    internal: true
    vars:
      # When PUSH=false, default to native arch (--load requires single platform)
      PUSH: '{{.PUSH | default "true"}}'
      PLATFORMS: '{{.PLATFORMS | default (ternary .NATIVE_ARCH .IMAGE_PLATFORMS (eq .PUSH "false"))}}'
      OUTPUT: '{{if eq .PUSH "true"}}--push{{else}}--load{{end}}'
      TAG_PREFIX: '{{if eq .PUSH "true"}}{{.IMAGE_REGISTRY}}/{{.IMAGE_NAMESPACE}}/{{end}}'
    preconditions:
      - sh: |
          if [ "{{.PUSH}}" != "false" ]; then
            exit 0
          fi
          if echo "{{.PLATFORMS}}" | tr -d ' ' | grep -q ','; then
            exit 1
          fi
          exit 0
        msg: "PUSH=false requires a single platform (e.g., PLATFORMS=linux/amd64)."
    deps:
      - buildx:setup
    cmds:
      - |
        docker buildx build \
          --builder {{.IMAGE_BUILDER}} \
          --platform {{.PLATFORMS}} \
          {{.BUILD_ARGS}} \
          -t {{.TAG_PREFIX}}{{.IMAGE_NAME}}:{{.VERSION}} \
          -f dockerfile/{{.DOCKERFILE}} \
          {{.OUTPUT}} \
          .
      - echo "‚úÖ {{.IMAGE_NAME}}:{{.VERSION}} built (push={{.PUSH}}, platforms={{.PLATFORMS}})"

  # ============================================================================
  # Internal task to build binaries based on PLATFORMS
  # ============================================================================

  _build-binaries:
    internal: true
    vars:
      PUSH: '{{.PUSH | default "true"}}'
      PLATFORMS: '{{.PLATFORMS | default (ternary .NATIVE_ARCH .IMAGE_PLATFORMS (eq .PUSH "false"))}}'
    cmds:
      # Build amd64 binary if needed
      - |
        if printf '%s' "{{.PLATFORMS}}" | tr ',' '\n' | tr -d ' ' | grep -qx "linux/amd64"; then
          task build:binary:{{.SERVICE}}:linux-amd64
        else
          :
        fi
      # Build arm64 binary if needed
      - |
        if printf '%s' "{{.PLATFORMS}}" | tr ',' '\n' | tr -d ' ' | grep -qx "linux/arm64"; then
          task build:binary:{{.SERVICE}}:linux-arm64
        else
          :
        fi

  # ============================================================================
  # Public Image Build Tasks
  # ============================================================================

  core:
    desc: "üê≥ Build Harbor Core image"
    cmds:
      - task: _build-binaries
        vars: { SERVICE: core, PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }
      - task: _build
        vars: { IMAGE_NAME: harbor-core, DOCKERFILE: core.dockerfile, BUILD_ARGS: "", PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }

  jobservice:
    desc: "üê≥ Build Harbor Jobservice image"
    cmds:
      - task: _build-binaries
        vars: { SERVICE: jobservice, PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }
      - task: _build
        vars: { IMAGE_NAME: harbor-jobservice, DOCKERFILE: jobservice.dockerfile, BUILD_ARGS: "", PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }

  registryctl:
    desc: "üê≥ Build Harbor Registryctl image"
    cmds:
      - task: _build-binaries
        vars: { SERVICE: registryctl, PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }
      - task: _build
        vars: { IMAGE_NAME: harbor-registryctl, DOCKERFILE: registryctl.dockerfile, BUILD_ARGS: "", PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }

  exporter:
    desc: "üê≥ Build Harbor Exporter image"
    cmds:
      - task: _build-binaries
        vars: { SERVICE: exporter, PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }
      - task: _build
        vars: { IMAGE_NAME: harbor-exporter, DOCKERFILE: exporter.dockerfile, BUILD_ARGS: "", PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }

  portal:
    desc: "üê≥ Build Harbor Portal image"
    cmds:
      - task: _build
        vars: { IMAGE_NAME: harbor-portal, DOCKERFILE: portal.dockerfile, BUILD_ARGS: "--build-arg BUN_VERSION={{.BUN_VERSION}}", PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }

  registry:
    desc: "üê≥ Build Docker Registry image"
    cmds:
      - task: _build
        vars: { IMAGE_NAME: harbor-registry, DOCKERFILE: registry.dockerfile, BUILD_ARGS: "--build-arg GO_VERSION={{.GO_VERSION}} --build-arg DISTRIBUTION_VERSION={{.DISTRIBUTION_VERSION}}", PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }

  trivy-adapter:
    desc: "üê≥ Build Trivy Adapter image"
    cmds:
      - task: _build
        vars: { IMAGE_NAME: harbor-trivy-adapter, DOCKERFILE: trivy-adapter.dockerfile, BUILD_ARGS: "", PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }

  nginx:
    desc: "üê≥ Build Harbor Nginx image"
    cmds:
      - task: _build
        vars: { IMAGE_NAME: harbor-nginx, DOCKERFILE: nginx.dockerfile, BUILD_ARGS: "", PUSH: "{{.PUSH}}", PLATFORMS: "{{.PLATFORMS}}" }

  # ============================================================================
  # Utilities
  # ============================================================================

  clean:
    desc: "üßπ Clean all Harbor Docker images"
    cmds:
      - |
        echo "Removing Harbor images..."
        docker images | grep -E "harbor" | awk '{print $3}' | sort -u | xargs -r docker rmi -f || true
        echo "‚úÖ Images cleaned"

  prune:
    desc: "üßπ Prune Docker build cache"
    cmds:
      - docker builder prune -f
      - echo "‚úÖ Build cache pruned"

  list:
    desc: "üìã List all Harbor images"
    cmds:
      - |
        echo "Harbor Images:"
        docker images | grep -E "harbor|REPOSITORY" || echo "No Harbor images found"

  inspect:*:
    desc: "üîç Inspect a multi-arch manifest"
    vars:
      IMAGE: '{{index .MATCH 0}}'
    cmds:
      - docker buildx imagetools inspect {{.IMAGE_REGISTRY}}/{{.IMAGE_NAMESPACE}}/{{.IMAGE}}:{{.VERSION}}
