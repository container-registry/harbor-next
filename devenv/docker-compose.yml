# Docker Compose - Local DevEnv
# All Harbor services run in containers with hot reload
# Services communicate via Docker network (no localhost issues)
#
# Port configuration: see ports.env (loaded by Taskfile)
# - CORE_PORT: Core API port (default: 8080)
# - PORTAL_PORT: Portal UI port (default: 4200)
# - PROJECT_PREFIX: Container name prefix (default: harbor)

services:
  postgresql:
    image: postgres:16-alpine
    container_name: ${PROJECT_PREFIX:-harbor}-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root123
      POSTGRES_DB: registry
    ports:
      - "5432:5432"
    volumes:
      - harbor-postgres-data:/var/lib/postgresql/data
      - ../make/migrations:/migrations

  redis:
    image: valkey/valkey:latest
    container_name: ${PROJECT_PREFIX:-harbor}-redis
    ports:
      - "6379:6379"
    volumes:
      - harbor-redis-data:/data

  registry:
    image: distribution/distribution:latest
    container_name: ${PROJECT_PREFIX:-harbor}-registry
    environment:
      OTEL_TRACES_EXPORTER: none
      OTEL_SDK_DISABLED: "true"
    ports:
      - "50000:5000"
    volumes:
      - harbor-registry-data:/var/lib/registry
      - ../devenv/registry.config.yml:/etc/registry/config.yml:ro

  # Core API - starts with: docker compose --profile core up
  core:
    build:
      context: ..
      dockerfile: dockerfiles/dev.dockerfile
    container_name: ${PROJECT_PREFIX:-harbor}-core
    profiles: [core]
    volumes:
      - ..:/app
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    ports:
      - "${CORE_PORT:-8080}:8080"
      # - "2345:2345"  # Debug port (uncomment if needed)
    environment:
      # Database
      POSTGRESQL_HOST: postgresql
      POSTGRESQL_PORT: "5432"
      POSTGRESQL_USERNAME: postgres
      POSTGRESQL_PASSWORD: root123
      POSTGRESQL_DATABASE: registry
      POSTGRESQL_SSLMODE: disable
      POSTGRES_MIGRATION_SCRIPTS_PATH: make/migrations/postgresql/
      # Redis
      _REDIS_URL_CORE: redis://redis:6379/1
      _REDIS_URL_REG: redis://redis:6379/2
      # Registry
      REGISTRY_URL: http://registry:5000
      REGISTRY_CONTROLLER_URL: http://registryctl:8080
      REGISTRY_CREDENTIAL_USERNAME: ""
      REGISTRY_CREDENTIAL_PASSWORD: ""
      # Core settings
      EXT_ENDPOINT: http://core:8080
      CORE_URL: http://core:8080
      HARBOR_ADMIN_PASSWORD: Harbor12345
      CACHE_ENABLED: "false"
      LOG_LEVEL: debug
      # Token signing key
      TOKEN_PRIVATE_KEY_PATH: devenv/token_service_key.pem
      # JobService
      JOBSERVICE_URL: http://jobservice:8888
      CORE_SECRET: devenv-secret-do-not-use-in-production
      JOBSERVICE_SECRET: devenv-secret-do-not-use-in-production
      # Trivy scanner
      TRIVY_ADAPTER_URL: http://trivy-adapter:8080
      WITH_TRIVY: "true"
      # Proxy cache and replication
      PERMITTED_REGISTRY_TYPES_FOR_PROXY_CACHE: docker-hub,harbor,azure-acr,ali-acr,aws-ecr,google-gcr,docker-registry,github-ghcr,jfrog-artifactory
      REPLICATION_ADAPTER_WHITELIST: ali-acr,aws-ecr,azure-acr,docker-hub,docker-registry,github-ghcr,google-gcr,harbor,huawei-SWR,jfrog-artifactory,tencent-tcr,volcengine-cr
    command: air -c devenv/air.core.toml
    depends_on:
      - postgresql
      - redis
      - registry
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/api/v2.0/ping"]
      interval: 5s
      timeout: 3s
      retries: 30

  # JobService - starts with: docker compose --profile jobservice up
  jobservice:
    build:
      context: ..
      dockerfile: dockerfiles/dev.dockerfile
    container_name: ${PROJECT_PREFIX:-harbor}-jobservice
    profiles: [jobservice]
    volumes:
      - ..:/app
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
    # ports:
    #   - "8888:8888"  # JobService API (uncomment if needed)
    #   - "2346:2346"  # Debug port (uncomment if needed)
    environment:
      # Database
      POSTGRESQL_HOST: postgresql
      POSTGRESQL_PORT: "5432"
      POSTGRESQL_USERNAME: postgres
      POSTGRESQL_PASSWORD: root123
      POSTGRESQL_DATABASE: registry
      POSTGRESQL_SSLMODE: disable
      # Redis
      REDIS_URL: redis://redis:6379
      # Core
      CORE_URL: http://core:8080
      CORE_SECRET: devenv-secret-do-not-use-in-production
      JOBSERVICE_SECRET: devenv-secret-do-not-use-in-production
      # Registry
      REGISTRY_URL: http://registry:5000
      REGISTRY_CONTROLLER_URL: http://registryctl:8080
      REGISTRY_CREDENTIAL_USERNAME: ""
      REGISTRY_CREDENTIAL_PASSWORD: ""
      TOKEN_SERVICE_URL: http://core:8080/service/token
      LOG_LEVEL: debug
    command: air -c devenv/air.jobservice.toml
    depends_on:
      core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8888/api/v1/stats"]
      interval: 5s
      timeout: 3s
      retries: 30

  # RegistryCtl - starts with: docker compose --profile registryctl up
  registryctl:
    build:
      context: ..
      dockerfile: dockerfiles/dev.dockerfile
    container_name: harbor-registryctl
    profiles: [registryctl]
    volumes:
      - ..:/app
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/root/.cache/go-build
      - harbor-registry-data:/var/lib/registry
      - ../devenv/registry.config.yml:/etc/registry/config.yml:ro
    ports:
      - "8085:8080"
      - "2347:2347"
    environment:
      PORT: "8080"
      LOG_LEVEL: debug
      REGISTRY_CONFIG: /etc/registry/config.yml
      CORE_SECRET: devenv-secret-do-not-use-in-production
      JOBSERVICE_SECRET: devenv-secret-do-not-use-in-production
    command: air -c devenv/air.registryctl.toml
    depends_on:
      - registry
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/api/health"]
      interval: 5s
      timeout: 3s
      retries: 30

  # Trivy scanner adapter - starts with: docker compose --profile trivy up
  trivy-adapter:
    image: goharbor/trivy-adapter-photon:v2.14.0
    container_name: ${PROJECT_PREFIX:-harbor}-trivy
    profiles: [trivy]
    environment:
      SCANNER_LOG_LEVEL: debug
      SCANNER_REDIS_URL: redis://redis:6379
      SCANNER_STORE_REDIS_URL: redis://redis:6379
      SCANNER_STORE_REDIS_NAMESPACE: harbor.scanner.trivy:store
      SCANNER_JOB_QUEUE_REDIS_URL: redis://redis:6379
      SCANNER_JOB_QUEUE_REDIS_NAMESPACE: harbor.scanner.trivy:job-queue
      SCANNER_TRIVY_CACHE_DIR: /tmp/trivy
      SCANNER_TRIVY_REPORTS_DIR: /tmp/reports
      SCANNER_TRIVY_VULN_TYPE: os,library
      SCANNER_TRIVY_SEVERITY: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
      SCANNER_TRIVY_INSECURE: "true"
      SCANNER_API_SERVER_ADDR: ":8080"
    ports:
      - "8081:8080"
    tmpfs:
      - /tmp:size=2G,mode=1777
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/probe/healthy"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Portal (Angular UI) - starts with: docker compose --profile portal up
  portal:
    build:
      context: ..
      dockerfile: dockerfiles/dev.portal.dockerfile
    container_name: ${PROJECT_PREFIX:-harbor}-portal
    profiles: [portal]
    volumes:
      - ../src/portal/src:/app/src
      - ../src/portal/scripts:/app/scripts:ro
      - ../src/portal/angular.json:/app/angular.json:ro
      - ../src/portal/tsconfig.json:/app/tsconfig.json:ro
      - ../src/portal/tsconfig.app.json:/app/tsconfig.app.json:ro
      - ./proxy.config.mjs:/app/proxy.config.mjs:ro
      - ../api/v2.0/swagger.yaml:/swagger.yaml:ro
    ports:
      - "${PORTAL_PORT:-4200}:4200"
    environment:
      HARBOR_PROXY_TARGET: "http://core:8080"
    depends_on:
      core:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4200"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  harbor-postgres-data:
    name: ${PROJECT_PREFIX:-harbor}-postgres-data
  harbor-redis-data:
    name: ${PROJECT_PREFIX:-harbor}-redis-data
  harbor-registry-data:
    name: ${PROJECT_PREFIX:-harbor}-registry-data
  go-mod-cache:
    name: ${PROJECT_PREFIX:-harbor}-go-mod-cache
  go-build-cache:
    name: ${PROJECT_PREFIX:-harbor}-go-build-cache
